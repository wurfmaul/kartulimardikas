<?php
if (!defined('BASEDIR')) die('You cannot call this script directly !');
if (!isset($_GET['aid'])) {
    header("Location:" . url(['action' => 'index']));
    die();
}
// get algorithm id
$aid = $_GET['aid'];

// get algorithm details from database
require_once BASEDIR . "includes/dataModel.php";
$_model = new DataModel();
$_algo = $_model->fetchAlgorithmByAID($aid);
$_model->close();

// prepare algorithm meta-data
$name = stripslashes($_algo->name);
$description = stripslashes($_algo->description);
$long_description = stripslashes($_algo->long_description);

// prepare variables
$vars = json_decode($_algo->variables);

// prepare tree
require_once BASEDIR . "includes/nodes.php";
$tree = new Tree(json_decode($_algo->tree));

// prepare sections
require_once BASEDIR . "includes/viewHelper.php";
$sectionNum = isset($_GET['section']) ? $_GET['section'] : SECTIONS_VIEW;
$section = sections($sectionNum, 6);
?>
<!-- HEADER -->
<div class="page-header">
    <?php if (isset($aid)): ?>
    <h1><?= $name ?> <small><?= $description ?></small></h1>
    <?php endif ?>
</div>

<!-- CONTENT -->
<div class="row">

<!-- LEFT COLUMN -->
<div class="col-md-6">

    <!-- ALGORITHM AREA -->
    <div class="panel-group" id="accordion-left">

        <!-- TAB - CONTROLS -->
        <div class="panel panel-default">
            <div class="panel-heading" data-toggle="collapse" data-target="#controls">
                <h4 class="panel-title">
                    <span class="glyphicon glyphicon-chevron-<?php if ($section[0]): ?>down<?php else: ?>right<?php endif ?>"></span>
                    <?= $l10n['controls'] ?>
                </h4>
            </div>
            <div id="controls" class=" panel-collapse collapse <?= $section[0] ? 'in' : 'closed' ?>">
                <div class="panel-body">
                    <div class="btn-group btn-group-justified">
                        <div class="btn-group">
                            <button type="button" class="btn btn-default" title="<?= $l10n['back_to_start'] ?>" id="btn-reset" disabled="disabled">
                                <span class="glyphicon glyphicon-fast-backward"></span>
                            </button>
                        </div>
                        <div class="btn-group">
                            <button type="button" class="btn btn-default" title="<?= $l10n['step_back'] ?>" id="btn-stepback" disabled="disabled">
                                <span class="glyphicon glyphicon-step-backward"></span>
                            </button>
                        </div>
                        <div class="btn-group">
                            <button type="button" class="btn btn-default" title="<?= $l10n['play'] ?>" id="btn-play" data-toggle="button">
                                <span class="glyphicon glyphicon-play" id="img-play"></span>
                            </button>
                        </div>
                        <div class="btn-group">
                            <button type="button" class="btn btn-default" title="<?= $l10n['step_forward'] ?>" id="btn-step">
                                <span class="glyphicon glyphicon-step-forward"></span>
                            </button>
                        </div>
                        <div class="btn-group">
                            <button type="button" class="btn btn-default" title="<?= $l10n['forward_to_end'] ?>" id="btn-finish">
                                <span class="glyphicon glyphicon-fast-forward"></span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB - PSEUDOCODE -->
        <div class="panel panel-default">
            <div class="panel-heading" data-toggle="collapse" data-target="#pseudocode">
                <h4 class="panel-title">
                    <span class="glyphicon glyphicon-chevron-<?php if ($section[1]): ?>down<?php else: ?>right<?php endif ?>"></span>
                    <?= $name ?>
                </h4>
            </div>
            <div id="pseudocode" class="panel-collapse collapse <?= $section[1] ? 'in' : 'closed' ?>">
                <div class="panel-body algorithm">
                    <ul><?php $tree->printHtml(['vars' => $vars]) ?></ul>
                </div>
            </div>
        </div>

        <!-- TAB - SOURCE CODE -->
        <div class="panel panel-default">
            <div class="panel-heading" data-toggle="collapse" data-target="#sourcecode">
                <h4 class="panel-title">
                    <span class="glyphicon glyphicon-chevron-<?php if ($section[2]): ?>down<?php else: ?>right<?php endif ?>"></span>
                    <?= $l10n['source_code'] ?>
                </h4>
            </div>
            <div id="sourcecode" class=" panel-collapse collapse <?= $section[2] ? 'in' : 'closed' ?>">
                <div class="panel-body">
                    <pre><?php $tree->printSource(['vars' => $vars]) ?></pre>
                </div>
            </div>
        </div>

        <!-- TAB - DESCRIPTION -->
        <div class="panel panel-default">
            <div class="panel-heading" data-toggle="collapse" data-target="#description">
                <h4 class="panel-title">
                    <span class="glyphicon glyphicon-chevron-<?php if ($section[3]): ?>down<?php else: ?>right<?php endif ?>"></span>
                    <?= $l10n['description'] ?>
                </h4>
            </div>
            <div id="description" class=" panel-collapse collapse <?= $section[3] ? 'in' : 'closed' ?>">
                <div class="panel-body">
                    <?= $long_description ?>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- LEFT COLUMN END -->

<!-- RIGHT COLUMN -->
<div class="col-md-6">
    <div class="panel-group" id="accordion-right">

        <!-- TAB - MEMORY -->
        <div class="panel panel-default">
            <div class="panel-heading" data-toggle="collapse" data-target="#memory">
                <h4 class="panel-title">
                    <span class="glyphicon glyphicon-chevron-<?php if ($section[4]): ?>down<?php else: ?>right<?php endif ?>"></span>
                    <?= $l10n['memory'] ?>
                </h4>
            </div>
            <div id="memory" class=" panel-collapse collapse <?= $section[4] ? 'in' : 'closed' ?>">
                <div class="panel-body">
                    <table class="table table-hover table-bordered">
                        <tr>
                            <th style="border-top: none;"><?= $l10n['variable'] ?></th>
                            <th style="border-top: none;"><?= $l10n['contents'] ?></th>
                        </tr>
                        <?php foreach($vars as $index => $var): ?>
                        <tr>
                            <td><code><?= $var->name ?></code></td>
                            <td>
                                <div class="btn-group">
                                    <?php if (substr($var->init, 0, 6) == "array-"): // deal with "array-{?,custom,random}" ?>
                                        <?php foreach (explode(',', $var->value) as $offset => $value): ?>
                                            <input type="button" class="btn btn-default" disabled="disabled"
                                                   value="<?= $value ?>" id="memory-<?= $var->name ?><?= $offset ?>" />
                                        <?php endforeach ?>
                                    <?php else: // deal with "elem-{?,value}" ?>
                                        <input type="button" class="btn btn-default" disabled="disabled"
                                               value="<?= $var->value ?>" id="memory-<?= $var->name ?>" />
                                    <?php endif ?>
                                </div>
                            </td>
                        </tr>
                        <?php endforeach ?>
                    </table>
                </div>
            </div>
        </div>

        <!-- TAB - STATISTICS -->
        <div class="panel panel-default">
            <div class="panel-heading" data-toggle="collapse" data-target="#statistics">
                <h4 class="panel-title">
                    <span class="glyphicon glyphicon-chevron-<?php if ($section[5]): ?>down<?php else: ?>right<?php endif ?>"></span>
                    <?= $l10n['statistics'] ?>
                </h4>
            </div>
            <div id="statistics" class="panel-collapse collapse <?= $section[5] ? 'in' : 'closed' ?>">
                <div class="panel-body">
                    <table class="table table-hover table-bordered">
                        <tr>
                            <th><?= $l10n['metric'] ?></th>
                            <th><?= $l10n['count'] ?></th>
                        </tr>
                        <tr>
                            <td><?= $l10n['nowo'] ?></td>
                            <td>
                                <div class="btn-group">
                                    <input type="button" class="btn btn-default" disabled="disabled" value="0" id="stats-now" />
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td><?= $l10n['noco'] ?></td>
                            <td>
                                <div class="btn-group">
                                    <input type="button" class="btn btn-default" disabled="disabled" value="0" id="stats-noc" />
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td><?= $l10n['nooo'] ?></td>
                            <td>
                                <div class="btn-group">
                                    <input type="button" class="btn btn-default" disabled="disabled" value="0" id="stats-noo" />
                                </div>
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- RIGHT COLUMN END -->

</div>
<!-- CONTENT END -->

<!-- TODO: remove link after presentation -->
<ul class="pager">
    <li class="previous"><a href="../pres/#/overview">&larr; Back to presentation</a></li>
</ul>