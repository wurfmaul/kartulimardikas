<?php
if (!defined('BASEDIR')) die('You cannot call this script directly !');
global $l10n;

// if algorithm is defined
if ($__aid && $__algorithm && ($__public || $__owner)):
    // prepare algorithm meta-data
    $name = stripslashes($__algorithm->name);
    $description = stripslashes($__algorithm->description);
    $long_description = stripslashes($__algorithm->long_description);

    // prepare variables
    $vars = json_decode($__algorithm->variables);

    // prepare tree
    require_once BASEDIR . "includes/algorithm.php";
    $tree = new Tree(json_decode($__algorithm->tree));

    // use algorithm header
    require_once BASEDIR . "partials/headers/algorithmHeader.phtml";
    ?>
    <!-- HEADER -->
    <div class="page-header">
        <h1><?= $name ?>
            <small><?= $description ?></small>
        </h1>
    </div>
    <!-- HEADER END -->

    <!-- CONTENT -->
    <div class="row">

        <!-- ERROR MESSAGE -->
        <div id="viewAlert" class="alert alert-danger" style="display:none">
            <strong><?= $l10n['runtime_error'] ?></strong><br/>
            <?= $l10n['message_runtime_error'] ?>
            <ul>
                <li id="viewAlertText"></li>
            </ul>
        </div>
        <!-- ERROR MESSAGE END -->

        <!-- LEFT COLUMN -->
        <div class="col-md-6">

            <!-- ALGORITHM AREA -->
            <div class="panel-group" id="accordion-left">

                <!-- TAB - CONTROLS -->
                <div class="panel panel-default">
                    <div class="panel-heading" data-target="#controls">
                        <h4 class="panel-title">
                            <span class="glyphicon glyphicon-chevron-down"></span>
                            <?= $l10n['controls'] ?>
                        </h4>
                    </div>
                    <div id="controls" class="panel-collapse">
                        <div class="panel-body controls">
                            <div class="col-md-5">
                                <div class="btn-group">
                                    <button type="button" class="btn btn-default" title="<?= $l10n['back_to_start'] ?>"
                                            id="btn-reset">
                                        <span class="glyphicon glyphicon-fast-backward"></span>
                                    </button>
                                    <button type="button" class="btn btn-default" title="<?= $l10n['play'] ?>"
                                            id="btn-play">
                                        <span class="glyphicon glyphicon-play" id="img-play"></span>
                                    </button>
                                    <button type="button" class="btn btn-default" title="<?= $l10n['step_forward'] ?>"
                                            id="btn-step">
                                        <span class="glyphicon glyphicon-step-forward"></span>
                                    </button>
                                    <button type="button" class="btn btn-default" title="<?= $l10n['forward_to_end'] ?>"
                                            id="btn-finish">
                                        <span class="glyphicon glyphicon-fast-forward"></span>
                                    </button>
                                </div>
                                <div id="speed-control">
                                    <table>
                                        <tr>
                                            <td><span class="fa fa-bicycle"></span></td>
                                            <td style="width:100%">
                                                <div id="speed-slider"></div>
                                            </td>
                                            <td><span class="fa fa-rocket"></span></td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                            <div class="col-md-7">
                                <div class="panel panel-default">
                                    <div class="panel-body">
                                        <span style="color: grey"><?= $l10n['no_params_to_define'] ?></span>
                                    </div>
                                    <div id="input-footer" class="panel-footer">
                                        <?= $l10n['input'] ?>
                                    </div>
                                </div>
                                <div class="panel panel-default">
                                    <div class="panel-body">
                                        <label for="returnValue" class="sr-only">Return value</label>
                                        <input id="returnValue" class="form-control input-sm" disabled="disabled">
                                    </div>
                                    <div id="output-footer" class="panel-footer">
                                        <?= $l10n['output'] ?>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- TAB - PSEUDOCODE -->
                <div class="panel panel-default">
                    <div class="panel-heading" data-target="#pseudocode">
                        <h4 class="panel-title">
                            <span class="glyphicon glyphicon-chevron-down"></span>
                            <?= $name ?>
                        </h4>
                    </div>
                    <div id="pseudocode" class="panel-collapse">
                        <div class="panel-body algorithm">
                            <?php if (is_null($__algorithm->tree)): ?>
                                <?= $l10n['no_algorithm'] ?>
                            <?php else: ?>
                                <ul id="node_<?= $tree->getRoot() ?>" class="insertStepsHere"
                                    data-node-id="<?= $tree->getRoot() ?>">
                                    <?php $tree->printHtml(['vars' => $vars, 'mode' => 'view']) ?>
                                </ul>
                            <?php endif ?>
                        </div>
                    </div>
                </div>

                <!-- TAB - SOURCE CODE -->
                <div class="panel panel-default">
                    <div class="panel-heading" data-target="#sourcecode">
                        <h4 class="panel-title">
                        <span
                            class="glyphicon glyphicon-chevron-down"></span>
                            <?= $l10n['source_code'] ?>
                        </h4>
                    </div>
                    <div id="sourcecode" class="panel-collapse">
                        <div class="panel-body">
                            <?php if (is_null($__algorithm->tree)): ?>
                                <?= $l10n['no_algorithm'] ?>
                            <?php else: ?>
                                <pre><?php $tree->printSource(['vars' => $vars]) ?></pre>
                            <?php endif ?>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- LEFT COLUMN END -->

        <!-- RIGHT COLUMN -->
        <div class="col-md-6">
            <div class="panel-group" id="accordion-right">
                <!-- TAB - DESCRIPTION -->
                <div class="panel panel-default">
                    <div class="panel-heading" data-target="#description">
                        <h4 class="panel-title">
                            <span class="glyphicon glyphicon-chevron-down"></span>
                            <?= $l10n['description'] ?>
                        </h4>
                    </div>
                    <div id="description" class="panel-collapse">
                        <div class="panel-body">
                            <?php if ($long_description): ?>
                            <?= $long_description ?>
                            <?php else: ?>
                                <?= $l10n['no_description'] ?>
                            <?php endif ?>
                        </div>
                    </div>
                </div>

                <!-- TAB - MEMORY -->
                <div class="panel panel-default">
                    <div class="panel-heading" data-target="#memory" data-speed="100">
                        <h4 class="panel-title">
                            <span class="glyphicon glyphicon-chevron-down"></span>
                            <?= $l10n['memory'] ?>
                        </h4>
                    </div>
                    <div id="memory" class="panel-collapse">
                        <div class="panel-body">
                            <?php if (sizeof($vars)): ?>
                                <table class="table table-hover table-bordered variables">
                                    <thead>
                                    <tr>
                                        <th style="border-top: none;"><?= $l10n['variable'] ?></th>
                                        <th style="border-top: none;"><?= $l10n['contents'] ?></th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    <?php foreach ($vars as $vid => $var): ?>
                                        <tr id="var-<?= $vid ?>"
                                            data-vid="<?= $vid ?>"
                                            data-name="<?= $var->name ?>"
                                            data-value="<?= $var->value ?>"
                                            data-type="<?= $var->type ?>">
                                            <td>
                                                <code class="name"><?= $var->name ?></code>
                                            </td>
                                            <td>
                                                <div class="btn-group">
                                                    <?php if (substr($var->type, 0, 6) === "array-"): // deal with "array-{int}" ?>
                                                        <?php foreach (explode(',', $var->value) as $offset => $value): ?>
                                                            <button
                                                                class="btn btn-default value-container offset_<?= $offset ?>"
                                                                disabled="disabled">
                                                                <span class="value"><?= $value ?></span>
                                                                <span class="glyphicon glyphicon-pencil write"></span>
                                                                <span class="glyphicon glyphicon-eye-open read"></span>
                                                            </button>
                                                        <?php endforeach ?>
                                                    <?php else: // deal with "elem-{?,value}" ?>
                                                        <button class="btn btn-default value-container"
                                                                disabled="disabled">
                                                            <span class="value"><?= $var->value ?></span>
                                                            <span class="glyphicon glyphicon-pencil write"></span>
                                                            <span class="glyphicon glyphicon-eye-open read"></span>
                                                        </button>
                                                    <?php endif ?>
                                                </div>
                                            </td>
                                        </tr>
                                    <?php endforeach ?>
                                    </tbody>
                                </table>
                            <?php else: ?>
                                <?= $l10n['no_vars'] ?>
                            <?php endif ?>
                        </div>
                    </div>
                </div>

                <!-- TAB - STATISTICS -->
                <div class="panel panel-default">
                    <div class="panel-heading" data-target="#statistics">
                        <h4 class="panel-title">
                        <span
                            class="glyphicon glyphicon-chevron-down"></span>
                            <?= $l10n['statistics'] ?>
                        </h4>
                    </div>
                    <div id="statistics" class="panel-collapse">
                        <div class="panel-body">
                            <table class="table table-hover table-bordered">
                                <thead>
                                <tr>
                                    <th><?= $l10n['operations'] ?></th>
                                    <th><?= $l10n['count'] ?></th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr>
                                    <td><?= $l10n['accesses'] ?></td>
                                    <td>
                                        <div class="btn-group">
                                            <input type="button" class="btn btn-default" disabled="disabled" value="0"
                                                   id="stats-accesses"/>
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td><?= $l10n['assignments'] ?></td>
                                    <td>
                                        <div class="btn-group">
                                            <input type="button" class="btn btn-default" disabled="disabled" value="0"
                                                   id="stats-assignments"/>
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td><?= $l10n['comparisons'] ?></td>
                                    <td>
                                        <div class="btn-group">
                                            <input type="button" class="btn btn-default" disabled="disabled" value="0"
                                                   id="stats-comparisons"/>
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td><?= $l10n['arithmetic'] ?></td>
                                    <td>
                                        <div class="btn-group">
                                            <input type="button" class="btn btn-default" disabled="disabled" value="0"
                                                   id="stats-arithmetic"/>
                                        </div>
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- RIGHT COLUMN END -->
    </div>
    <script type="text/javascript">
        // hand default values over to js
        window.defaults.sectionDefault = <?= SECTIONS_VIEW ?>;
        window.defaults.maxSteps = <?= MAX_STEPS ?>;
        window.defaults.speed = <?= SPEED ?>;
        // hand error messages over to js
        window.errorCodes = {
            <?php foreach ($l10n['runtime_errors'] as $key => $value): ?>
            '<?= $key ?>': "<?= $value ?>",
            <?php endforeach ?>
        }
    </script>
    <!-- CONTENT END -->
<?php else: // no valid aid ?>
    <div class="alert alert-danger" role="alert">
        <strong><?= $l10n['error'] ?></strong><br/>

        <?= $l10n['message_invalid_aid'] ?>
        <ul>
            <li><?= $l10n['message_no_aid_specified'] ?></li>
            <li><?= $l10n['message_deleted_algorithm'] ?></li>
            <li><?= $l10n['message_hidden_algorithm'] ?></li>
        </ul>
        <br/>
        &rarr; <a href="javascript:history.back()"><?= $l10n['go_back'] ?></a>
    </div>
<?php endif ?>